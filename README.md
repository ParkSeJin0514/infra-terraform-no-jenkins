# ğŸ—ï¸ PetClinic EKS Infrastructure (Terraform)

AWS EKS ê¸°ë°˜ PetClinic MSA ì¸í”„ë¼ë¥¼ Terraformìœ¼ë¡œ í”„ë¡œë¹„ì €ë‹í•˜ëŠ” í”„ë¡œì íŠ¸ì…ë‹ˆë‹¤.

## ğŸ“‹ ëª©ì°¨

- [ì•„í‚¤í…ì²˜](#ì•„í‚¤í…ì²˜)
- [ëª¨ë“ˆ êµ¬ì¡°](#ëª¨ë“ˆ-êµ¬ì¡°)
- [ì‚¬ì „ ìš”êµ¬ì‚¬í•­](#ì‚¬ì „-ìš”êµ¬ì‚¬í•­)
- [Quick Start](#quick-start)
- [ìƒì„¸ ì„¤ì •](#ìƒì„¸-ì„¤ì •)
- [ì ‘ì† ê°€ì´ë“œ](#ì ‘ì†-ê°€ì´ë“œ)
- [ì •ë¦¬](#ì •ë¦¬)

---

## ğŸ—ï¸ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              AWS Cloud (ap-northeast-2)                     â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                         VPC (10.0.0.0/16)                             â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚    Public Subnets       â”‚    â”‚       Private Subnets           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                         â”‚    â”‚                                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ Bastion â”‚            â”‚    â”‚  â”‚  Mgmt   â”‚   â”‚ EKS Workers â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  Host   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â–¶â”‚ Instanceâ”‚   â”‚  (x3 nodes) â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                         â”‚    â”‚                                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚   NAT   â”‚            â”‚    â”‚  â”‚        RDS MySQL        â”‚    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ Gateway â”‚            â”‚    â”‚  â”‚     (Private DB)        â”‚    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                         â”‚    â”‚                                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  AZ-a        AZ-c       â”‚    â”‚  AZ-a                  AZ-c     â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚                    EKS Control Plane                          â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ ArgoCD          â€¢ AWS Load Balancer Controller             â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ EFS CSI Driver  â€¢ External Secrets Operator                â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚  â”‚     ECR     â”‚  â”‚   Secrets   â”‚  â”‚     IAM     â”‚                         â”‚
â”‚  â”‚  Registry   â”‚  â”‚   Manager   â”‚  â”‚    Roles    â”‚                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ ëª¨ë“ˆ êµ¬ì¡°

```
infra-terraform/
â”œâ”€â”€ main.tf                 # ëª¨ë“ˆ í˜¸ì¶œ ë° aws-auth ì„¤ì •
â”œâ”€â”€ variables.tf            # ë³€ìˆ˜ ì •ì˜
â”œâ”€â”€ terraform.tfvars        # ë³€ìˆ˜ ê°’ ì„¤ì •
â”œâ”€â”€ outputs.tf              # ì¶œë ¥ ê°’
â”œâ”€â”€ providers.tf            # Provider ì„¤ì •
â”œâ”€â”€ version.tf              # Terraform ë²„ì „
â”œâ”€â”€ data.tf                 # Data sources
â”œâ”€â”€ eks-addons.tf           # EKS Add-ons (ALB, EFS, External Secrets)
â”œâ”€â”€ iam-mgmt.tf             # Management IAM Role
â”œâ”€â”€ keypair.tf              # SSH Key Pair
â”œâ”€â”€ keys/                   # SSH í‚¤ íŒŒì¼
â”‚   â”œâ”€â”€ test
â”‚   â””â”€â”€ test.pub
â””â”€â”€ modules/
    â”œâ”€â”€ network/            # VPC, Subnet, NAT Gateway
    â”œâ”€â”€ ec2/                # Bastion, Management Instance
    â”œâ”€â”€ eks/                # EKS Cluster, Node Group
    â”œâ”€â”€ db/                 # RDS MySQL
    â””â”€â”€ argocd/             # ArgoCD Helm ì„¤ì¹˜
```

### ëª¨ë“ˆë³„ ì„¤ëª…

| ëª¨ë“ˆ | ë¦¬ì†ŒìŠ¤ | ì„¤ëª… |
|------|--------|------|
| **network** | VPC, Subnet, NAT GW, IGW | ë„¤íŠ¸ì›Œí¬ ì¸í”„ë¼ |
| **ec2** | Bastion, Mgmt EC2 | ì ‘ì† ë° ê´€ë¦¬ìš© ì¸ìŠ¤í„´ìŠ¤ |
| **eks** | EKS Cluster, Node Group | Kubernetes í´ëŸ¬ìŠ¤í„° |
| **db** | RDS MySQL | ë°ì´í„°ë² ì´ìŠ¤ |
| **argocd** | ArgoCD (Helm) | GitOps CD ë„êµ¬ |

---

## ğŸ“¦ ì‚¬ì „ ìš”êµ¬ì‚¬í•­

### ë¡œì»¬ í™˜ê²½

```bash
# Terraform
terraform version  # >= 1.0.0

# AWS CLI
aws --version
aws configure      # ìê²© ì¦ëª… ì„¤ì •

# kubectl
kubectl version --client
```

### AWS ê¶Œí•œ

í•„ìš”í•œ IAM ê¶Œí•œ:
- VPC ì „ì²´ ê¶Œí•œ
- EC2 ì „ì²´ ê¶Œí•œ
- EKS ì „ì²´ ê¶Œí•œ
- RDS ì „ì²´ ê¶Œí•œ
- IAM ì—­í• /ì •ì±… ìƒì„±
- Secrets Manager
- ECR

---

## ğŸš€ Quick Start

### 1. SSH í‚¤ ìƒì„±

```bash
mkdir -p keys
ssh-keygen -t rsa -b 4096 -f keys/test -N ""
```

### 2. ë³€ìˆ˜ ì„¤ì •

```bash
# terraform.tfvars ìˆ˜ì • ë˜ëŠ” í™˜ê²½ë³€ìˆ˜ ì„¤ì •
export TF_VAR_db_password="YourSecurePassword123!"
```

### 3. ë°°í¬

```bash
terraform init
terraform plan
terraform apply
```

### 4. ì¶œë ¥ í™•ì¸

```bash
terraform output
terraform output -raw argocd_admin_password
```

---

## âš™ï¸ ìƒì„¸ ì„¤ì •

### VPC ì„¤ì •

| í•­ëª© | ê¸°ë³¸ê°’ | ì„¤ëª… |
|------|--------|------|
| vpc_cidr | 10.0.0.0/16 | VPC CIDR ë¸”ë¡ |
| az_count | 2 | ì‚¬ìš©í•  AZ ê°œìˆ˜ (1~4) |
| project_name | petclinic-kr | í”„ë¡œì íŠ¸ ì´ë¦„ (ë¦¬ì†ŒìŠ¤ íƒœê¹…) |

### EKS ì„¤ì •

| í•­ëª© | ê¸°ë³¸ê°’ | ì„¤ëª… |
|------|--------|------|
| eks_version | 1.33 | Kubernetes ë²„ì „ |
| eks_instance_types | t3.large | Worker Node ì¸ìŠ¤í„´ìŠ¤ íƒ€ì… |
| eks_desired_size | 3 | ë…¸ë“œ ê¸°ë³¸ ê°œìˆ˜ |
| eks_min_size | 3 | ë…¸ë“œ ìµœì†Œ ê°œìˆ˜ |
| eks_max_size | 6 | ë…¸ë“œ ìµœëŒ€ ê°œìˆ˜ |
| eks_capacity_type | ON_DEMAND | ON_DEMAND ë˜ëŠ” SPOT |

### RDS ì„¤ì •

| í•­ëª© | ê¸°ë³¸ê°’ | ì„¤ëª… |
|------|--------|------|
| db_engine | mysql | ë°ì´í„°ë² ì´ìŠ¤ ì—”ì§„ |
| db_engine_version | 8.0 | MySQL ë²„ì „ |
| db_instance_class | db.t3.micro | ì¸ìŠ¤í„´ìŠ¤ í´ë˜ìŠ¤ |
| db_name | petclinic | ë°ì´í„°ë² ì´ìŠ¤ ì´ë¦„ |
| db_username | admin | ê´€ë¦¬ì ê³„ì • |
| db_multi_az | false | Multi-AZ ë°°í¬ |

### EC2 ì„¤ì •

| í•­ëª© | ê¸°ë³¸ê°’ | ì„¤ëª… |
|------|--------|------|
| ami | Ubuntu 24.04 | AMI ID |
| bastion_instance_type | t3.micro | Bastion ì¸ìŠ¤í„´ìŠ¤ íƒ€ì… |
| mgmt_instance_type | t3.small | Mgmt ì¸ìŠ¤í„´ìŠ¤ íƒ€ì… |

---

## ğŸ”Œ EKS Add-ons

ìë™ìœ¼ë¡œ ì„¤ì¹˜ë˜ëŠ” ì»´í¬ë„ŒíŠ¸:

| Add-on | ìš©ë„ |
|--------|------|
| **AWS Load Balancer Controller** | ALB/NLB Ingress ê´€ë¦¬ |
| **EFS CSI Driver** | EFS ë³¼ë¥¨ ë§ˆìš´íŠ¸ |
| **External Secrets Operator** | Secrets Manager ì—°ë™ |
| **ArgoCD** | GitOps CD |

---

## ğŸ”— ì ‘ì† ê°€ì´ë“œ

### 1. Bastion Host ì ‘ì†

```bash
ssh -i keys/test ubuntu@<BASTION_PUBLIC_IP>
```

### 2. Management Instance ì ‘ì† (Bastion ê²½ìœ )

```bash
ssh -i keys/test -J ubuntu@<BASTION_IP> ubuntu@<MGMT_PRIVATE_IP>
```

### 3. kubeconfig ì„¤ì • (Mgmtì—ì„œ)

```bash
aws eks update-kubeconfig --name petclinic-kr-eks --region ap-northeast-2
kubectl get nodes
```

### 4. RDS ì ‘ì† (Mgmtì—ì„œ)

```bash
mysql -h <RDS_ENDPOINT> -P 3306 -u admin -p
```

### 5. ArgoCD ì ‘ì†

```bash
# Port Forward
kubectl port-forward svc/argocd-server -n argocd 8080:80

# ë¸Œë¼ìš°ì €ì—ì„œ http://localhost:8080
# Username: admin
# Password: terraform output -raw argocd_admin_password
```

---

## ğŸ—‘ï¸ ì •ë¦¬

```bash
# ì „ì²´ ë¦¬ì†ŒìŠ¤ ì‚­ì œ
terraform destroy

# íŠ¹ì • ë¦¬ì†ŒìŠ¤ë§Œ ì‚­ì œ
terraform destroy -target=module.argocd
```

> âš ï¸ **ì£¼ì˜**: RDSì— `deletion_protection = true`ì¸ ê²½ìš° ì‚­ì œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

---

## ğŸ“Š ì˜ˆìƒ ë¹„ìš©

| ë¦¬ì†ŒìŠ¤ | ì‚¬ì–‘ | ì›” ì˜ˆìƒ ë¹„ìš© (USD) |
|--------|------|-------------------|
| EKS Control Plane | - | ~$73 |
| EC2 (Worker x3) | t3.large | ~$180 |
| EC2 (Bastion) | t3.micro | ~$8 |
| EC2 (Mgmt) | t3.small | ~$17 |
| RDS | db.t3.micro | ~$15 |
| NAT Gateway | - | ~$32 |
| **í•©ê³„** | | **~$325/ì›”** |

> ğŸ’¡ ê°œë°œ í™˜ê²½ì—ì„œëŠ” `eks_capacity_type = "SPOT"` ì‚¬ìš©ìœ¼ë¡œ ë¹„ìš© ì ˆê° ê°€ëŠ¥

---

## ğŸ“ License

This project is licensed under the MIT License.